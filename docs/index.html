<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Kalorientracker by Cxrgi</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">

  <link rel="stylesheet" href="style.css">
</head>
<body>
  <header>
    <div class="titlewrap">
      <h1>Kalorientracker</h1>
      <h2>Tracke ganz einfach deine Kalorien</h2>
    </div>
    <div style="display:flex; gap:8px; align-items:center">
      <button id="calendarBtnHeader" title="Heute anzeigen" style="background:transparent;border:none;font-weight:700;cursor:pointer">üìÖ</button>
    </div>
  </header>

  <main>
    <section class="left-col" style="width:100%">
      <div class="goal-row">
        <label for="kalorienziel" style="min-width:fit-content">Kalorienziel:</label>
        <input id="kalorienziel" type="number" placeholder="z.B. 2500" />
        <input id="submitBtn" type="submit" value="Als Ziel setzen">
      </div>

      <p id="outputText"></p>

      <div id="progressContainer">
        <div id="progressBar"></div>
      </div>
      <p id="warnText" style="margin-top:0.6rem;font-weight:700"></p>

      <div id="macroBarContainer">
        <div id="macroBar">
          <div class="macro-segment fat" title="Fett"></div>
          <div class="macro-segment protein" title="Protein"></div>
          <div class="macro-segment carbs" title="Kohlenhydrate"></div>
        </div>
        <p id="macroInfoText"></p>
      </div>

      <hr style="margin:1rem 0;">

      <h2 style="margin-top:0.6rem">Trage nun deine Kalorien ein:</h2>

      <div id="tools">
        <button id="addEntryBtn">‚ûï</button>

        <button id="prevDayBtn" title="Vorheriger Tag" style="display:none;">¬´</button>
        <button id="calendarBtn" title="Datum w√§hlen"></button>
        <button id="nextDayBtn" title="N√§chster Tag" style="display:none;">¬ª</button>

        <button id="purgeBtn" title="Mehrfach-L√∂schen aktivieren">üßπ</button>

        <span id="purgeControls" style="display:none; margin-left:10px;">
          <button id="cancelPurgeBtn">üîô</button>
          <button id="selectAllBtn">Alle ausw√§hlen</button>
        </span>
      </div>

      <h3 id="entryCountText">Du hast heute 0 Eintr√§ge eingetragen.</h3>

      <div id="sortSection">
        <label for="sortSelect">Sortieren nach: </label>
        <select id="sortSelect">
          <option value="date">Zuletzt hinzugef√ºgt</option>
          <option value="name">Name (A‚ÄìZ)</option>
          <option value="calories">Kalorien</option>
          <option value="amount">Menge</option>
        </select>
        <button id="sortDirectionBtn" title="Sortierrichtung √§ndern">‚¨áÔ∏è</button>
        <label style="display:flex; align-items: center; gap:6px; margin-left:auto">
          <input type="checkbox" id="groupByCategory" /> Nach Kategorien gruppieren
        </label>
      </div>

    </section>

    <aside class="right-col" style="width:100%; margin-top:12px">
      <div id="entries"></div>
      <div id="entryList"></div>
    </aside>

    <div id="notificationContainer"></div>
  </main>

  <script>
    document.addEventListener('DOMContentLoaded', function(){
      const cbH = document.getElementById('calendarBtnHeader');
      const cb = document.getElementById('calendarBtn');
      if(cbH && cb){
        cbH.addEventListener('click', ()=> {
          saveEntriesForDate(selectedDate);
          selectedDate = new Date();
          loadEntriesForDate(selectedDate);
          if(calendarOpen) {
              cb.textContent = formatDisplayDate(selectedDate);
          }
        })
      }
    });
  </script>

  <script>
    let kalorienziel = ""
    let kalorienRN = 0
    let currentDate = new Date()
    let selectedDate = new Date(currentDate)

    const inputField = document.getElementById("kalorienziel")
    const submitButton = document.getElementById("submitBtn")
    const outputText = document.getElementById("outputText")

    function pad(n) {
        return String(n).padStart(2, "0")
    }

    function getDateKey(date) {
        const y = date.getFullYear()
        const m = pad(date.getMonth() + 1)
        const d = pad(date.getDate())
        return `${y}-${m}-${d}`
    }

    function formatDisplayDate(date) {
        const days = ["So.", "Mo.", "Di.", "Mi.", "Do.", "Fr.", "Sa."]
        const dayName = days[date.getDay()]
        const d = String(date.getDate()).padStart(2, "0")
        const m = String(date.getMonth() + 1).padStart(2, "0")
        const y = String(date.getFullYear()).slice(2)
        return `${dayName} ${d}.${m}.${y}`
    }

    if (localStorage.getItem("kalorienziel")) {
        kalorienziel = parseInt(localStorage.getItem("kalorienziel"))
    }

    if (localStorage.getItem("kalorienRN")) {
        kalorienRN = parseInt(localStorage.getItem("kalorienRN"))
    }

    inputField.addEventListener("keydown", function (e) {
        if (e.key === "e" || e.key === "E" || e.key === "+" || e.key === "-") {
            e.preventDefault();
        }
        if (e.key === "Enter") {
            e.preventDefault();
            submitButton.click();
        }
    });

    function updateOutput() {
        let prozent = 0
        if (kalorienziel > 0) {
            prozent = Math.min(100, Math.round((kalorienRN / kalorienziel) * 100))
        }

        let warnText = ""
        if (kalorienziel > 0) {
            if (kalorienRN > kalorienziel + 100) {
                const diff = kalorienRN - kalorienziel
                warnText = `üö® Du hast dein Kalorienziel um ${diff} Kalorien √ºberschritten!`
            } else if (kalorienRN >= kalorienziel) {
                warnText = "‚úÖ Du hast dein heutiges Kalorienziel erreicht!"
            }
        }

        outputText.textContent = `Kalorien: ${kalorienRN} von ${kalorienziel} kcal | ${prozent}%`

        const progressBar = document.getElementById("progressBar")
        progressBar.style.width = prozent + "%"

        if (prozent <= 33) {
            progressBar.style.background = "linear-gradient(to right, #ff4d4d, #ff944d)"
        } else if (prozent <= 66) {
            progressBar.style.background = "linear-gradient(to right, #ff944d, #ffd24d)"
        } else {
            progressBar.style.background = "linear-gradient(to right, #ffd24d, #4dff4d)"
        }

        const warnTextElem = document.getElementById("warnText")
        warnTextElem.textContent = warnText

        localStorage.setItem("kalorienziel", kalorienziel)
        localStorage.setItem("kalorienRN", kalorienRN)

        updateMacroBar();
    }


    function updateMacroBar() {
        const entries = entryList.querySelectorAll("p");
        let totalFat = 0, totalProtein = 0, totalCarbs = 0, totalKcal = 0;

        entries.forEach(p => {
            totalFat += parseFloat(p.dataset.fat) || 0;
            totalProtein += parseFloat(p.dataset.protein) || 0;
            totalCarbs += parseFloat(p.dataset.carbs) || 0;
            totalKcal += parseInt(p.dataset.calories, 10) || 0;
        });

        const total = totalFat + totalProtein + totalCarbs;
        if (total === 0) {
            document.querySelectorAll(".macro-segment").forEach(seg => seg.style.width = "0%");
            document.getElementById("macroInfoText").textContent = "";
            return;
        }

        const fatPct = (totalFat / total) * 100;
        const proteinPct = (totalProtein / total) * 100;
        const carbsPct = (totalCarbs / total) * 100;

        const fatEl = document.querySelector(".macro-segment.fat");
        const protEl = document.querySelector(".macro-segment.protein");
        const carbEl = document.querySelector(".macro-segment.carbs");

        fatEl.style.width = fatPct + "%";
        protEl.style.width = proteinPct + "%";
        carbEl.style.width = carbsPct + "%";

        fatEl.setAttribute("data-label", `Fett: ${fatPct.toFixed(1)}%`);
        protEl.setAttribute("data-label", `Protein: ${proteinPct.toFixed(1)}%`);
        carbEl.setAttribute("data-label", `Kohlenhydrate: ${carbsPct.toFixed(1)}%`);

        document.getElementById("macroInfoText").textContent =
             `Gesamt: ${totalFat.toFixed(1)}g Fett | ${totalProtein.toFixed(1)}g Protein | ${totalCarbs.toFixed(1)}g Kohlenhydrate`;
    }

    function recalcCalories() {
        kalorienRN = 0
        entryList.querySelectorAll("p").forEach(entry => {
            const calories = parseInt(entry.dataset.calories, 10);
            if (!isNaN(calories)) {
                kalorienRN += calories;
            }
        })
        updateOutput()
    }

    inputField.addEventListener("input", function () {
        kalorienziel = inputField.value
    })

    submitButton.addEventListener("click", function () {
        if (kalorienziel < 100) {
            kalorienziel = 100
        }
        updateOutput()
        inputField.value = ""
    })

    function updateEntryCount() {
        const count = entryList.querySelectorAll("p").length
        if (count === 1) {
            entryCountText.textContent = `Du hast heute ${count} Eintrag eingetragen.`
        } else {
            entryCountText.textContent = `Du hast heute ${count} Eintr√§ge eingetragen.`
        }
    }

    function ensureButtons(p) {
        const existingActions = p.querySelector(".entry-actions");
        if (existingActions) existingActions.remove();
        const existingDetails = p.querySelector(".macro-details");
        if (existingDetails) existingDetails.remove();

        let mainRow = p.querySelector(".entry-main-row");
        if (!mainRow) {
            mainRow = document.createElement("div");
            mainRow.className = "entry-main-row";
            mainRow.innerHTML = p.innerHTML;
            p.innerHTML = '';
            p.appendChild(mainRow);
        }

        const editBtn = document.createElement("button");
        editBtn.textContent = "üñäÔ∏è";
        editBtn.classList.add("edit-btn");

        const deleteBtn = document.createElement("button");
        deleteBtn.textContent = "‚ùå";
        deleteBtn.classList.add("delete-btn");

        const buttonGroup = document.createElement("span");
        buttonGroup.classList.add("entry-buttons");
        buttonGroup.appendChild(editBtn);
        buttonGroup.appendChild(deleteBtn);
        
        const actionContainer = document.createElement('div');
        actionContainer.className = 'entry-actions';
        actionContainer.appendChild(buttonGroup);

        const fat = (p.dataset.fat || "").toString().trim();
        const protein = (p.dataset.protein || "").toString().trim();
        const carbs = (p.dataset.carbs || "").toString().trim();
        const hasMacro = [fat, protein, carbs].some(v => v !== "" && v !== "null" && v !== "undefined");

        if (hasMacro) {
            const expandBtn = document.createElement("button");
            expandBtn.classList.add("expand-btn");
            expandBtn.textContent = "üîΩ";
            expandBtn.title = "Details anzeigen";

            const details = document.createElement("div");
            details.classList.add("macro-details");
            details.style.display = "none";
            
            const protText = protein !== "" ? `${protein} g` : "Keine Angabe";
            const fatText = fat !== "" ? `${fat} g` : "Keine Angabe";
            const carbsText = carbs !== "" ? `${carbs} g` : "Keine Angabe";

            details.innerHTML = `
                <div><strong>Protein:</strong> ${protText}</div>
                <div><strong>Fett:</strong> ${fatText}</div>
                <div><strong>Kohlenhydrate:</strong> ${carbsText}</div>
            `;
            
            expandBtn.addEventListener("click", function (e) {
                e.stopPropagation();
                if (details.style.display === "none") {
                    details.style.display = "block";
                    expandBtn.textContent = "üîº";
                    expandBtn.title = "Details verbergen";
                } else {
                    details.style.display = "none";
                    expandBtn.textContent = "üîΩ";
                    expandBtn.title = "Details anzeigen";
                }
            });

            actionContainer.appendChild(expandBtn);
            p.appendChild(details);
        }
        
        mainRow.appendChild(actionContainer);
    }

    function setupEnterNavigation(inputs, submitButton) {
        inputs.forEach((el, idx) => {
            if (!el) return;
            el.addEventListener("keydown", function (e) {
                if (e.key === "Enter") {
                    e.preventDefault();
                    const next = inputs[idx + 1];
                    if (next) {
                        next.focus();
                        if (next.select) next.select();
                    } else if (submitButton && typeof submitButton.click === "function") {
                        submitButton.click();
                    }
                }
            });
        });
    }
    
    function sortEntries() {
        const allPs = Array.from(entryList.querySelectorAll("p"))
        const sortBy = sortSelect.value
        const dir = sortDirection === "asc" ? 1 : -1

        allPs.sort(function (a, b) {
            const valA = a.dataset;
            const valB = b.dataset;
            
            if (sortBy === "date") {
                return (parseInt(valA.timestamp, 10) - parseInt(valB.timestamp, 10)) * dir;
            }
            if (sortBy === "name") {
                return (valA.name || "").localeCompare(valB.name || "") * dir;
            }
            if (sortBy === "calories") {
                return (parseInt(valA.calories, 10) - parseInt(valB.calories, 10)) * dir;
            }
            if (sortBy === "amount") {
                const amountA = parseInt(valA.amount, 10);
                const amountB = parseInt(valB.amount, 10);
                if (amountA !== amountB) return (amountA - amountB) * dir;
                return (parseInt(valA.calories, 10) - parseInt(valB.calories, 10)) * dir;
            }
            return 0;
        });

        const categories = ["Fr√ºhst√ºck", "Mittagessen", "Abendessen", "Snack"]
        entryList.innerHTML = ""

        if (groupByCategoryCheckbox && groupByCategoryCheckbox.checked) {
            categories.forEach(cat => {
                const header = document.createElement("div")
                header.classList.add("category-header")
                header.textContent = cat + " ‚ñæ"

                const container = document.createElement("div")
                container.classList.add("category-container")
                
                const entriesForCat = allPs.filter(p => p.dataset.category === cat);
                if (entriesForCat.length > 0) {
                    entriesForCat.forEach(p => {
                        ensureButtons(p);
                        attachEntryEvents(p);
                        container.appendChild(p);
                    });
                } else {
                    const emptyNote = document.createElement("div")
                    emptyNote.textContent = "Keine Eintr√§ge"
                    emptyNote.classList.add("empty-category-note");
                    container.appendChild(emptyNote)
                }
                
                header.addEventListener("click", function () {
                    if (container.style.display === "none") {
                        container.style.display = "block"
                        header.textContent = cat + " ‚ñæ"
                    } else {
                        container.style.display = "none"
                        header.textContent = cat + " ‚ñ∏"
                    }
                });
                
                entryList.appendChild(header);
                entryList.appendChild(container);
            });
        } else {
            allPs.forEach(p => {
                ensureButtons(p);
                attachEntryEvents(p);
                entryList.appendChild(p);
            });
        }
    }
  </script>

  <script>
    const addEntryBtn = document.getElementById("addEntryBtn")
    const entriesDiv = document.getElementById("entries")
    const entryList = document.getElementById("entryList")
    const entryCountText = document.getElementById("entryCountText")
    const sortSelect = document.getElementById("sortSelect")
    const sortDirectionBtn = document.getElementById("sortDirectionBtn")
    const groupByCategoryCheckbox = document.getElementById("groupByCategory")
    const purgeBtn = document.getElementById("purgeBtn")
    const purgeControls = document.getElementById("purgeControls")
    const selectAllBtn = document.getElementById("selectAllBtn")
    const cancelPurgeBtn = document.getElementById("cancelPurgeBtn")
    const calendarBtn = document.getElementById("calendarBtn")
    const prevDayBtn = document.getElementById("prevDayBtn")
    const nextDayBtn = document.getElementById("nextDayBtn")

    let purgeMode = false
    let sortDirection = "desc"
    let isEntryActive = false
    let calendarOpen = false;

    function handleSortOrGroup(event) {
        if (isEntryActive) {
            showNotification("Bitte schlie√üe zuerst die Bearbeitung.");
            if (event && event.target.type === 'checkbox') {
                event.target.checked = !event.target.checked;
            }
            return;
        }
        sortEntries();
    }
    
    groupByCategoryCheckbox.addEventListener("change", handleSortOrGroup);
    sortSelect.addEventListener("change", handleSortOrGroup);
    sortDirectionBtn.addEventListener("click", function () {
        if (isEntryActive) {
            showNotification("Bitte schlie√üe zuerst die Bearbeitung.");
            return;
        }
        sortDirection = (sortDirection === 'asc') ? 'desc' : 'asc';
        sortDirectionBtn.textContent = sortDirection === "asc" ? "‚¨ÜÔ∏è" : "‚¨áÔ∏è";
        sortEntries();
    });

    /**
     * NEU: L√§dt Eintr√§ge aus dem Local Storage.
     * Liest eine JSON-Liste und baut die HTML-Elemente neu auf.
     */
    function loadEntriesForDate(date) {
        const key = "entries_" + getDateKey(date);
        const saved = localStorage.getItem(key);
        entryList.innerHTML = ""; 

        if (saved) {
            try {
                const entriesData = JSON.parse(saved);
                if (Array.isArray(entriesData)) {
                    entriesData.forEach(data => {
                        const newEntry = document.createElement("p");
                        Object.assign(newEntry.dataset, data);

                        const name = data.name || "Unbekannt";
                        const totalCal = data.calories || 0;
                        const singleCal = data.singleCalories || 0;
                        const amount = data.amount || 1;
                        const time = data.time || "--:--";

                        newEntry.innerHTML = `<div class="entry-main-row"><span class="entry-content">
                            <div><strong>Speise:</strong> ${name}</div>
                            <div><strong>Kalorien:</strong> ${totalCal} ${amount > 1 ? `(${singleCal} kcal)`: ''}</div>
                            <div><strong>Menge:</strong> ${amount}</div>
                            <div><strong>Zeit:</strong> üïì ${time}</div>
                        </span></div>`;
                        
                        entryList.appendChild(newEntry);
                    });
                }
            } catch (e) {
                console.error("Fehler beim Laden der Eintr√§ge. Alte Daten werden evtl. gel√∂scht.", e);
                localStorage.removeItem(key);
            }
        }

        recalcCalories();
        updateEntryCount();
        sortEntries();
    }

    /**
     * NEU: Speichert alle Eintr√§ge als saubere JSON-Daten im Local Storage.
     */
    function saveEntriesForDate(date) {
        const key = "entries_" + getDateKey(date);
        const entriesData = [];
        entryList.querySelectorAll("p").forEach(p => {
            entriesData.push(p.dataset);
        });
        localStorage.setItem(key, JSON.stringify(entriesData));
    }


    function attachEntryEvents(entry) {
        const editBtn = entry.querySelector(".edit-btn")
        const deleteBtn = entry.querySelector(".delete-btn")
        
        if (deleteBtn) {
            deleteBtn.onclick = function () {
                entry.remove()
                recalcCalories()
                updateEntryCount()
                saveEntriesForDate(selectedDate)
                sortEntries();
            }
        }
        
        if (editBtn) {
            editBtn.onclick = function () {
                if (isEntryActive) {
                    showNotification("Bitte schlie√üe zuerst die andere Bearbeitung.");
                    return;
                }
                const oldData = entry.dataset;
                const oldName = oldData.name || "";
                const oldSingleCal = oldData.singleCalories || "0";
                const oldAmount = oldData.amount || "1";
                const oldTime = oldData.time || "12:00";
                const oldCategory = oldData.category || "Snack";
                const oldFat = oldData.fat || "";
                const oldProtein = oldData.protein || "";
                const oldCarbs = oldData.carbs || "";

                isEntryActive = true;
                const editDiv = document.createElement("div");

                const tabsHeader = document.createElement("div");
                tabsHeader.style.display = "flex";
                tabsHeader.style.gap = "8px";
                tabsHeader.style.marginBottom = "6px";

                const tabAllgBtn = document.createElement("button");
                tabAllgBtn.type = "button";
                tabAllgBtn.textContent = "Allgemein";
                tabAllgBtn.classList.add("tab-btn", "active");

                const tabMakrosBtn = document.createElement("button");
                tabMakrosBtn.type = "button";
                tabMakrosBtn.textContent = "Makros";
                tabMakrosBtn.classList.add("tab-btn");

                tabsHeader.append(tabAllgBtn, tabMakrosBtn);

                const allgContent = document.createElement("div");
                allgContent.style.display = "block";

                const editNameLabel = document.createElement("label"); editNameLabel.textContent = "Speise: ";
                const editNameInput = document.createElement("input"); editNameInput.type = "text"; editNameInput.value = oldName;

                const editCalLabel = document.createElement("label"); editCalLabel.textContent = "Kalorien (pro St√ºck):";
                const editCalInput = document.createElement("input"); editCalInput.type = "number"; editCalInput.value = oldSingleCal;

                const editAmountLabel = document.createElement("label"); editAmountLabel.textContent = "Menge:";
                const editAmountInput = document.createElement("input"); editAmountInput.type = "number"; editAmountInput.value = oldAmount;

                const editTimeLabel = document.createElement("label"); editTimeLabel.textContent = "Uhrzeit:";
                const editTimeInput = document.createElement("input"); editTimeInput.type = "time"; editTimeInput.value = oldTime;

                const editCategoryLabel = document.createElement("label"); editCategoryLabel.textContent = "Kategorie:";
                const editCategorySelect = document.createElement("select");
                editCategorySelect.innerHTML = `<option value="Fr√ºhst√ºck">Fr√ºhst√ºck</option><option value="Mittagessen">Mittagessen</option><option value="Abendessen">Abendessen</option><option value="Snack">Snack</option>`;
                editCategorySelect.value = oldCategory;

                allgContent.append(editNameLabel, editNameInput, editCalLabel, editCalInput, editAmountLabel, editAmountInput, editTimeLabel, editTimeInput, editCategoryLabel, editCategorySelect);

                const makrosContent = document.createElement("div");
                makrosContent.style.display = "none";

                const editFatLabel = document.createElement("label"); editFatLabel.textContent = "Fett (g):";
                const editFatInput = document.createElement("input"); editFatInput.type = "number"; editFatInput.min = 0; editFatInput.value = oldFat;

                const editProteinLabel = document.createElement("label"); editProteinLabel.textContent = "Protein (g):";
                const editProteinInput = document.createElement("input"); editProteinInput.type = "number"; editProteinInput.min = 0; editProteinInput.value = oldProtein;

                const editCarbsLabel = document.createElement("label"); editCarbsLabel.textContent = "Kohlenhydrate (g):";
                const editCarbsInput = document.createElement("input"); editCarbsInput.type = "number"; editCarbsInput.min = 0; editCarbsInput.value = oldCarbs;

                makrosContent.append(editFatLabel, editFatInput, editProteinLabel, editProteinInput, editCarbsLabel, editCarbsInput);

                tabAllgBtn.addEventListener("click", () => {
                    tabAllgBtn.classList.add("active"); tabMakrosBtn.classList.remove("active");
                    allgContent.style.display = "block"; makrosContent.style.display = "none";
                });
                tabMakrosBtn.addEventListener("click", () => {
                    tabMakrosBtn.classList.add("active"); tabAllgBtn.classList.remove("active");
                    makrosContent.style.display = "block"; allgContent.style.display = "none";
                });

                const saveBtn = document.createElement("button"); saveBtn.textContent = "üíæ Speichern";
                const cancelBtn = document.createElement("button"); cancelBtn.textContent = "üîô Abbrechen"; cancelBtn.style.marginLeft = "10px";
                
                setupEnterNavigation([editNameInput, editCalInput, editAmountInput, editTimeInput, editCategorySelect], saveBtn);

                saveBtn.onclick = function () {
                    const newName = editNameInput.value.trim();
                    const newSingleCal = parseInt(editCalInput.value, 10);
                    const newAmount = parseInt(editAmountInput.value, 10) || 1;
                    const newTime = editTimeInput.value;
                    const newCategory = editCategorySelect.value;
                    const newFat = editFatInput.value || "";
                    const newProtein = editProteinInput.value || "";
                    const newCarbs = editCarbsInput.value || "";

                    if (!newName || isNaN(newSingleCal)) {
                        showNotification("Bitte g√ºltige Werte eingeben!"); return;
                    }
                    const newTotalCal = newSingleCal * newAmount;
                    
                    const p = document.createElement("p");
                    Object.assign(p.dataset, {
                        timestamp: oldData.timestamp, name: newName, calories: newTotalCal, 
                        singleCalories: newSingleCal, amount: newAmount, time: newTime,
                        category: newCategory, fat: newFat, protein: newProtein, carbs: newCarbs
                    });
                    
                    p.innerHTML = `<div class="entry-main-row"><span class="entry-content">
                        <div><strong>Speise:</strong> ${newName}</div>
                        <div><strong>Kalorien:</strong> ${newTotalCal} ${newAmount > 1 ? `(${newSingleCal} kcal)`: ''}</div>
                        <div><strong>Menge:</strong> ${newAmount}</div>
                        <div><strong>Zeit:</strong> üïì ${newTime}</div>
                    </span></div>`;

                    ensureButtons(p);
                    attachEntryEvents(p);
                    editDiv.replaceWith(p);
                    
                    isEntryActive = false;
                    recalcCalories();
                    sortEntries();
                    saveEntriesForDate(selectedDate);
                };

                cancelBtn.onclick = function () {
                    editDiv.replaceWith(entry);
                    isEntryActive = false;
                };

                editDiv.append(tabsHeader, allgContent, makrosContent, saveBtn, cancelBtn);
                entry.replaceWith(editDiv);
                editNameInput.focus();
            };
        }
    }
    
    isEntryActive = false
    updateOutput()
    updateEntryCount()

    document.addEventListener("keydown", function(e) {
        if (e.key === "+") {
            e.preventDefault()
            if (!isEntryActive && !purgeMode) {
                addEntryBtn.click()
                return
            }
            if (isEntryActive) {
                const submit = entriesDiv.querySelector(".submit-entry-btn")
                if (submit) submit.click()
            }
        }
    })

    document.addEventListener("keydown", function (e) {
        if (e.key === "Escape" && isEntryActive) {
            const activeEntry = entriesDiv.querySelector("div")
            if (activeEntry) {
                entriesDiv.removeChild(activeEntry)
                isEntryActive = false
            }
        }
    })
    
    calendarBtn.textContent = formatDisplayDate(selectedDate)
    calendarBtn.addEventListener("click", function () {
        calendarOpen = !calendarOpen
        if (calendarOpen) {
            prevDayBtn.style.display = "inline-block";
            nextDayBtn.style.display = "inline-block";
            calendarBtn.textContent = formatDisplayDate(selectedDate);
        } else {
            prevDayBtn.style.display = "none";
            nextDayBtn.style.display = "none";
            calendarBtn.textContent = "üìÖ";
            
            // NEU: Springe zum heutigen Tag, wenn der Kalender geschlossen wird.
            saveEntriesForDate(selectedDate);
            selectedDate = new Date();
            loadEntriesForDate(selectedDate);
        }
    });

    prevDayBtn.addEventListener("click", function () {
        saveEntriesForDate(selectedDate);
        selectedDate.setDate(selectedDate.getDate() - 1);
        calendarBtn.textContent = formatDisplayDate(selectedDate);
        loadEntriesForDate(selectedDate);
    });

    nextDayBtn.addEventListener("click", function () {
        saveEntriesForDate(selectedDate);
        selectedDate.setDate(selectedDate.getDate() + 1);
        calendarBtn.textContent = formatDisplayDate(selectedDate);
        loadEntriesForDate(selectedDate);
    });

    purgeBtn.addEventListener("click", function () {
        if (purgeMode) {
            const checkboxes = document.querySelectorAll(".purge-checkbox:checked")
            if (purgeBtn.dataset.confirm === "true") {
                if (checkboxes.length > 0) {
                    checkboxes.forEach(cb => cb.closest("p")?.remove());
                    recalcCalories()
                    updateEntryCount()
                    saveEntriesForDate(selectedDate)
                }
                endPurgeMode();
            } else if (checkboxes.length > 0) {
                purgeBtn.textContent = "üßπ L√∂schen best√§tigen?";
                purgeBtn.dataset.confirm = "true";
                setTimeout(() => {
                    purgeBtn.textContent = "üßπ";
                    purgeBtn.dataset.confirm = "false";
                }, 3000);
            } else {
                endPurgeMode();
            }
        } else {
            purgeMode = true;
            entryList.classList.add('purge-active');
            purgeBtn.dataset.confirm = "false";
            purgeBtn.textContent = "üßπ";
            purgeControls.style.display = "inline-flex";
            entryList.querySelectorAll("p").forEach(entry => {
                if (!entry.querySelector(".purge-checkbox")) {
                    const checkbox = document.createElement("input");
                    checkbox.type = "checkbox";
                    checkbox.classList.add("purge-checkbox");
                    entry.prepend(checkbox);
                }
            });
        }
    });

    selectAllBtn.addEventListener("click", function () {
        const checkboxes = document.querySelectorAll(".purge-checkbox");
        const allChecked = Array.from(checkboxes).every(cb => cb.checked);
        checkboxes.forEach(cb => cb.checked = !allChecked);
    });

    cancelPurgeBtn.addEventListener("click", endPurgeMode);

    function endPurgeMode() {
        purgeMode = false;
        entryList.classList.remove('purge-active');
        purgeBtn.textContent = "üßπ";
        purgeBtn.dataset.confirm = "false";
        purgeControls.style.display = "none";
        document.querySelectorAll(".purge-checkbox").forEach(cb => cb.remove());
    }

    addEntryBtn.addEventListener("click", function () {
        if (isEntryActive) {
            showNotification("Bitte beende zuerst deinen aktuellen Eintrag!");
            return;
        }
        isEntryActive = true;

        const entryDiv = document.createElement("div");

        const tabsHeader = document.createElement("div");
        tabsHeader.style.display = "flex";
        tabsHeader.style.gap = "8px";
        tabsHeader.style.marginBottom = "6px";
        const tabAllgBtn = document.createElement("button");
        tabAllgBtn.type = "button"; tabAllgBtn.textContent = "Allgemein"; tabAllgBtn.classList.add("tab-btn", "active");
        const tabMakrosBtn = document.createElement("button");
        tabMakrosBtn.type = "button"; tabMakrosBtn.textContent = "Makros"; tabMakrosBtn.classList.add("tab-btn");
        tabsHeader.append(tabAllgBtn, tabMakrosBtn);

        const allgContent = document.createElement("div"); allgContent.style.display = "block";
        const makrosContent = document.createElement("div"); makrosContent.style.display = "none";

        const nameLabel = document.createElement("label"); nameLabel.textContent = "Speise:";
        const nameInput = document.createElement("input"); nameInput.type = "text"; nameInput.placeholder = "Name (z.B. Apfel)";
        const calLabel = document.createElement("label"); calLabel.textContent = "Kalorien (pro St√ºck):";
        const calInput = document.createElement("input"); calInput.type = "number"; calInput.placeholder = "z.B. 114";
        const amountLabel = document.createElement("label"); amountLabel.textContent = "Menge:";
        const amountInput = document.createElement("input"); amountInput.type = "number"; amountInput.value = 1; amountInput.min = 1;
        const timeLabel = document.createElement("label"); timeLabel.textContent = "Uhrzeit:";
        const timeInput = document.createElement("input"); timeInput.type = "time"; timeInput.value = new Date().toTimeString().slice(0, 5);
        const categoryLabel = document.createElement("label"); categoryLabel.textContent = "Kategorie:";
        const categorySelect = document.createElement("select");
        categorySelect.innerHTML = `<option value="Fr√ºhst√ºck">Fr√ºhst√ºck</option><option value="Mittagessen">Mittagessen</option><option value="Abendessen">Abendessen</option><option value="Snack">Snack</option>`;
        categorySelect.value = "Snack";
        allgContent.append(nameLabel, nameInput, calLabel, calInput, amountLabel, amountInput, timeLabel, timeInput, categoryLabel, categorySelect);

        const fatLabel = document.createElement("label"); fatLabel.textContent = "Fett (g):";
        const fatInput = document.createElement("input"); fatInput.type = "number"; fatInput.min = 0; fatInput.placeholder = "z.B. 5";
        const proteinLabel = document.createElement("label"); proteinLabel.textContent = "Protein (g):";
        const proteinInput = document.createElement("input"); proteinInput.type = "number"; proteinInput.min = 0; proteinInput.placeholder = "z.B. 12";
        const carbsLabel = document.createElement("label"); carbsLabel.textContent = "Kohlenhydrate (g):";
        const carbsInput = document.createElement("input"); carbsInput.type = "number"; carbsInput.min = 0; carbsInput.placeholder = "z.B. 30";
        setupProductAutocomplete(nameInput, calInput, fatInput, proteinInput, carbsInput);
        makrosContent.append(fatLabel, fatInput, proteinLabel, proteinInput, carbsLabel, carbsInput);

        tabAllgBtn.addEventListener("click", () => {
            tabAllgBtn.classList.add("active"); tabMakrosBtn.classList.remove("active");
            allgContent.style.display = "block"; makrosContent.style.display = "none";
        });
        tabMakrosBtn.addEventListener("click", () => {
            tabMakrosBtn.classList.add("active"); tabAllgBtn.classList.remove("active");
            makrosContent.style.display = "block"; allgContent.style.display = "none";
        });

        const submitEntryBtn = document.createElement("button"); submitEntryBtn.textContent = "Hinzuf√ºgen"; submitEntryBtn.classList.add("submit-entry-btn");
        const cancelEntryBtn = document.createElement("button"); cancelEntryBtn.textContent = "üîô Abbrechen"; cancelEntryBtn.style.marginLeft = "10px";
        
        cancelEntryBtn.addEventListener("click", () => {
            entriesDiv.removeChild(entryDiv); isEntryActive = false;
        });

        setupEnterNavigation([nameInput, calInput, amountInput, timeInput, categorySelect], submitEntryBtn);

        submitEntryBtn.addEventListener("click", function () {
            const name = nameInput.value.trim();
            const cal = parseInt(calInput.value, 10);
            const amount = parseInt(amountInput.value, 10);
            if (!name || isNaN(cal) || cal <= 0 || isNaN(amount) || amount <= 0) {
                showNotification("Bitte alle Felder korrekt ausf√ºllen!"); return;
            }
            
            const totalCal = cal * amount;
            const newEntry = document.createElement("p");
            Object.assign(newEntry.dataset, {
                timestamp: Date.now(), name: name, calories: totalCal, singleCalories: cal,
                amount: amount, time: timeInput.value, category: categorySelect.value,
                fat: fatInput.value || "", protein: proteinInput.value || "", carbs: carbsInput.value || ""
            });

            newEntry.innerHTML = `<div class="entry-main-row"><span class="entry-content">
                <div><strong>Speise:</strong> ${name}</div>
                <div><strong>Kalorien:</strong> ${totalCal} ${amount > 1 ? `(${cal} kcal)`: ''}</div>
                <div><strong>Menge:</strong> ${amount}</div>
                <div><strong>Zeit:</strong> üïì ${timeInput.value}</div>
            </span></div>`;
            
            entryList.appendChild(newEntry);

            recalcCalories();
            updateEntryCount();
            sortEntries();
            saveEntriesForDate(selectedDate);

            entriesDiv.removeChild(entryDiv);
            isEntryActive = false;
        });

        entryDiv.append(tabsHeader, allgContent, makrosContent, submitEntryBtn, cancelEntryBtn);
        entriesDiv.appendChild(entryDiv);
        nameInput.focus();
    });

    sortDirectionBtn.textContent = sortDirection === "asc" ? "‚¨ÜÔ∏è" : "‚¨áÔ∏è"
    calendarBtn.textContent = "üìÖ"
    selectedDate = new Date()
    loadEntriesForDate(selectedDate)

  </script>

  <script>
    function showNotification(message) {
        const container = document.getElementById("notificationContainer")
        const note = document.createElement("div")
        note.classList.add("notification")
        note.innerHTML = `<span>${message}</span><button>‚ùå</button>`
        note.querySelector("button").addEventListener("click", () => hideNotification(note))
        container.prepend(note)
        requestAnimationFrame(() => note.classList.add("show"))
        setTimeout(() => hideNotification(note), 3000)
    }
    function hideNotification(note) {
        note.classList.remove("show")
        setTimeout(() => note.remove(), 500)
    }
  </script>

  <script>
    function setupProductAutocomplete(inputEl, kcalEl, fatEl, protEl, carbEl) {
        if (typeof productDatabase === 'undefined') return;
        const suggestionBox = document.createElement("div");
        suggestionBox.classList.add("suggestion-box");
        inputEl.parentNode.appendChild(suggestionBox);

        inputEl.addEventListener("input", () => {
            const val = inputEl.value.trim().toLowerCase();
            suggestionBox.innerHTML = "";
            if (val.length < 2) { suggestionBox.style.display = "none"; return; }
            const matches = productDatabase
            .map(p => ({ p, idx: p.name.toLowerCase().indexOf(val) }))
            .filter(x => x.idx >= 0)
            .sort((a, b) => (a.idx - b.idx) || (a.p.name.length - b.p.name.length))
            .slice(0, 4).map(m => m.p);

            if (matches.length === 0) { suggestionBox.style.display = "none"; return; }

            matches.forEach(p => {
                const item = document.createElement("div");
                item.textContent = p.name;
                item.classList.add("suggestion-item");
                item.addEventListener("click", () => {
                    inputEl.value = p.name;
                    if (kcalEl) kcalEl.value = p.kcal;
                    if (fatEl) fatEl.value = p.fat;
                    if (protEl) protEl.value = p.protein;
                    if (carbEl) carbEl.value = p.carbs;
                    suggestionBox.style.display = "none";
                });
                suggestionBox.appendChild(item);
            });
            suggestionBox.style.display = "block";
        });
        document.addEventListener("click", e => {
            if (!suggestionBox.contains(e.target) && e.target !== inputEl) {
                suggestionBox.style.display = "none";
            }
        });
    }
  </script>

  <script src="foodDatabase.js"></script>

  </body>
</html>